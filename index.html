<script>
    function setDate() {
        const dateElement = document.getElementById("dateDisplay");
        const now = new Date();
        const formattedDate = now.toLocaleDateString("pt-BR") + " " + now.toLocaleTimeString("pt-BR", { hour: '2-digit', minute: '2-digit' });
        dateElement.textContent = formattedDate;
    }
    setDate();

    async function checkAccess() {
        let inputCode = prompt("Digite o cÃ³digo de acesso:");
        const sessionId = generateSessionId();

        const response = await fetch('/.netlify/functions/game', {
            method: 'POST',
            body: JSON.stringify({ action: 'checkAccess', code: inputCode, sessionId }),
            headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();
        if (data.error) {
            alert(data.error);
            if (data.error.includes("Acesso negado")) {
                document.body.innerHTML = "<h1>Acesso negado: VocÃª jÃ¡ jogou hoje ðŸ˜…!</h1>";
            } else {
                location.reload();
            }
        } else {
            document.getElementById("game").style.display = "block";
        }
    }

    function generateSessionId() {
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
            const r = Math.random() * 16 | 0;
            const v = c === 'x' ? r : (r & 0x3 | 0x8);
            return v.toString(16);
        });
    }

    let sessionId = generateSessionId();
    checkAccess();

    async function playGame() {
        const response = await fetch('/.netlify/functions/game', {
            method: 'POST',
            body: JSON.stringify({ action: 'play', sessionId }),
            headers: { 'Content-Type': 'application/json' },
        });

        const data = await response.json();
        if (data.error) {
            alert(data.error);
            document.getElementById("playButton").style.display = "none";
            return;
        }

        function revealNumber(index) {
            if (index < data.numbers.length) {
                let slot = document.getElementById("slot" + (index + 1));
                slot.classList.add("spin");
                setTimeout(() => {
                    slot.innerText = data.numbers[index];
                    slot.classList.remove("spin");
                    revealNumber(index + 1);
                }, 500);
            } else {
                updateGame(data);
            }
        }
        revealNumber(0);
    }

    function updateGame(data) {
        document.getElementById("attempts").innerText = data.attemptsLeft;
        document.getElementById("result").innerText = data.message;
        if (data.win) {
            document.getElementById("playButton").style.display = "none";
            showVictoryAnimation();
        } else if (data.attemptsLeft <= 0) {
            document.getElementById("playButton").style.display = "none";
        }
    }

    function showVictoryAnimation() {
        document.body.classList.add("win-animation");
        setTimeout(() => {
            document.body.classList.remove("win-animation");
        }, 5000);
    }
</script>